<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUMENFALL - El Atrio</title>
    
    <!-- Open Graph Meta Tags (para Redes Sociales) -->
    <meta property="og:title" content="LUMENFALL - El Atrio">
    <meta property="og:description" content="El universo 'Lumenfall'. Activos oficiales del demo, el lore y la marca Joziel.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="assets/imagenes/LUMENFALL-JUEGO-512x512.png">
    
    <!-- Apple Touch Icons (para iOS / iPhone / iPad) -->
    <link rel="apple-touch-icon" href="assets/imagenes/LUMENFALL-JUEGO-180x180.png">
    <link rel="apple-touch-icon" sizes="120x120" href="assets/imagenes/LUMENFALL-JUEGO-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="assets/imagenes/LUMENFALL-JUEGO-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/imagenes/LUMENFALL-JUEGO-152x152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="assets/imagenes/LUMENFALL-JUEGO-167x167.png">

    <!-- Metas para PWA -->
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">

    <!-- Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuración personalizada de Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'display': ['Impact', 'Arial Black', 'sans-serif'], // Fuente dramática
                    },
                    colors: {
                        cyan: {
                            DEFAULT: '#00ffff',
                            400: '#22d3ee', // Tailwind default fallback
                        }
                    }
                },
            },
        };
    </script>

    <style>
        /* Importar la fuente de Google para la firma */
        @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap');

        /* Estilo base */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }

        /* --- FASE 1: Estilos del Splash Screen --- */
        
        #splash-screen {
            transition: opacity 0.5s ease-in-out;
        }
        
        #splash-screen.fade-out {
            opacity: 0;
        }
        
        /* --- FASE 2: Estilos de la Página Principal --- */

        #bg-video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background-color: black;
        }
        
        .bg-video-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* Eliminado el blur para nitidez cinematográfica */
        }
        
        #main-content {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        /* Efectos de Texto Neón */
        .neon-hover:hover {
            color: #00ffff;
            text-shadow: 0 0 8px rgba(0, 255, 255, 0.6);
        }

        .neon-active:active {
            color: #ffffff;
            text-shadow: 0 0 15px rgba(0, 255, 255, 1), 0 0 30px rgba(0, 255, 255, 0.8);
            transform: scale(0.98);
        }

        /* --- FASE 3: Autenticación Pro (Visual Identity) --- */

        /* Spinner de carga minimalista */
        .auth-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #00FFFF; /* Cyan */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Avatar Místico (CSS Pure) */
        .mystic-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            /* Radial Gradient: Deep Space Style */
            background: radial-gradient(circle at center, #1a202c 0%, #000000 100%);
            /* Borde brillante: Cyan/Fuego */
            border: 2px solid #00FFFF;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Great Vibes', cursive; /* Firma elegante */
            font-size: 1.5rem;
            color: white;
            text-shadow: 0 0 5px #00FFFF;
            overflow: hidden;
        }

        /* Ocultar contenedor de auth por defecto para evitar flicker */
        #auth-container {
            display: none;
        }

    </style>
</head>

<body class="bg-black text-white antialiased">

    <!-- FASE 1: Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-black z-50 flex items-center justify-center">
        <img src="assets/imagenes/icono-inicio-web/icono-joziel-2.png" alt="Joziel" class="max-w-[80%] max-h-[80%] object-contain">
    </div>

    <!-- FASE 2: Contenido Principal -->
    <div id="main-content" class="relative z-10 min-h-screen flex flex-col">
        
        <!-- Language Flags (Always visible) -->
        <div class="fixed top-4 left-4 z-40 flex space-x-2">
            <button id="lang-btn-es" class="w-8 h-8 rounded-full overflow-hidden border border-gray-600 hover:border-white transition-colors focus:outline-none opacity-100" title="Español">
                <img src="https://flagcdn.com/w80/es.png" alt="Español" class="w-full h-full object-cover">
            </button>
            <button id="lang-btn-en" class="w-8 h-8 rounded-full overflow-hidden border border-gray-600 hover:border-white transition-colors focus:outline-none opacity-50" title="English">
                <img src="https://flagcdn.com/w80/us.png" alt="English" class="w-full h-full object-cover">
            </button>
        </div>

        <!-- Top Right User UI (Hidden when logged out) -->
        <div id="user-avatar-container" class="fixed top-4 right-4 z-40 hidden">
             <div class="relative">
                <button id="user-avatar-btn" class="w-12 h-12 rounded-full border-2 border-teal-500 overflow-hidden focus:outline-none focus:ring-2 focus:ring-teal-400">
                    <!-- Default Avatar / User Photo -->
                    <img id="user-avatar-img" src="assets/imagenes/icono-inicio-web/icono-joziel-2.png" alt="User" class="w-full h-full object-cover bg-gray-800">
                </button>

                <!-- Dropdown Menu -->
                <div id="user-dropdown" class="absolute right-0 mt-2 w-64 bg-gray-900 border border-gray-700 rounded-lg shadow-xl py-2 hidden">
                    <div class="px-4 py-3 border-b border-gray-700">
                        <p class="text-xs text-gray-400 uppercase tracking-wider" data-i18n="operator_label">Operador</p>
                        <p id="menu-user-email" class="text-sm text-white font-bold truncate">user@example.com</p>
                    </div>

                    <div class="px-4 py-3 bg-black/30">
                         <p class="text-[10px] text-yellow-500 font-mono mb-1" data-i18n="access_code_label">CÓDIGO DE ACCESO</p>
                         <p id="menu-game-code" class="text-lg text-white font-mono tracking-widest font-bold">----</p>
                    </div>

                    <a href="#" id="menu-logout-btn" class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-gray-800 hover:text-red-300 transition-colors" data-i18n="logout_btn">
                        Cerrar Sesión
                    </a>
                </div>
             </div>
        </div>

        <!-- Login Modal (Hidden by default) -->
        <div id="auth-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm">
            <div class="bg-gray-900 border border-gray-700 rounded-xl p-8 max-w-sm w-full shadow-2xl relative">
                <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>

                <h2 class="text-2xl font-bold text-white mb-6 text-center" data-i18n="modal_title">Acceso de Operador</h2>

                <div class="space-y-4">
                     <!-- 1. Google Button -->
                    <button id="modal-google-btn" class="w-full flex items-center justify-center p-3 rounded-lg font-semibold transition-colors duration-200 bg-white text-gray-800 hover:bg-gray-200">
                        <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M43.6111 20.0833H42V20H24V28H35.303C33.6747 32.6596 29.2235 36 24 36C17.373 36 12 30.627 12 24C12 17.373 17.373 12 24 12C26.8543 12 29.4312 13.1118 31.3914 14.888L36.0121 10.2672C32.6393 7.2898 28.5363 5.5 24 5.5C13.797 5.5 5.5 13.797 5.5 24C5.5 34.203 13.797 42.5 24 42.5C34.203 42.5 42.5 34.203 42.5 24C42.5 22.6105 42.3699 21.3533 42.126 20.1388L43.6111 20.0833Z" fill="#FFC107"></path><path d="M43.6111 20.0833H42V20H24V28H35.303C34.5102 30.4187 33.1594 32.5539 31.3914 34.1118L36.0121 38.7328C39.4239 35.034 42.5 29.16 42.5 24C42.5 22.6105 42.3699 21.3533 42.126 20.1388L43.6111 20.0833Z" fill="#FF3D00"></path><path d="M24 5.5C28.5363 5.5 32.6393 7.2898 36.0121 10.2672L31.3914 14.888C29.4312 13.1118 26.8543 12 24 12C20.6974 12 17.817 13.4357 16.0352 15.6961L11.0264 11.8346C14.3315 8.1636 18.892 5.5 24 5.5Z" fill="#4CAF50"></path><path d="M43.6111 20.0833L42.126 20.1388C42.3699 21.3533 42.5 22.6105 42.5 24C42.5 29.16 39.4239 35.034 36.0121 38.7328L31.3914 34.1118C33.1594 32.5539 34.5102 30.4187 35.303 28H24V20H42V20.0833H43.6111Z" fill="#1976D2"></path></svg>
                        <span data-i18n="google_login">Iniciar con Google</span>
                    </button>

                     <!-- 2. GitHub Button -->
                    <button id="modal-github-btn" class="w-full flex items-center justify-center p-3 rounded-lg font-semibold transition-colors duration-200 bg-gray-800 text-white hover:bg-black border border-gray-600">
                        <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg>
                        <span data-i18n="github_login">Iniciar con GitHub</span>
                    </button>

                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-gray-600"></div>
                        <span class="flex-shrink-0 mx-4 text-gray-500 text-xs uppercase" data-i18n="or_email">O usa tu Correo</span>
                        <div class="flex-grow border-t border-gray-600"></div>
                    </div>

                    <form id="email-auth-form" class="space-y-4">
                        <div>
                            <input type="email" id="modal-email" placeholder="nombre@ejemplo.com" class="w-full bg-gray-800 border border-gray-600 rounded p-3 text-white focus:border-teal-500 focus:outline-none text-center" required>
                        </div>

                        <div id="auth-success-msg" class="text-green-400 text-sm text-center hidden bg-green-900/30 p-2 rounded border border-green-800">
                             ¡Enlace enviado! Revisa tu correo.
                        </div>

                        <div id="auth-error-msg" class="text-red-500 text-sm text-center hidden"></div>

                        <button type="button" id="modal-magic-link-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white py-3 rounded font-semibold transition-colors" data-i18n="send_magic_link">
                            Recibir Enlace de Acceso
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- MOTOR DE VIDEO "CINE" (BACKGROUND) -->
        <div id="bg-video-container">
            <!-- Capa 1: Video Activo -->
            <video id="bg-video-1" class="bg-video-layer transition-opacity duration-1000 opacity-100" muted playsinline>
                <!-- JS insertará el source -->
            </video>

            <!-- Capa 2: Video Buffer (para transiciones) -->
            <video id="bg-video-2" class="bg-video-layer transition-opacity duration-1000 opacity-0" muted playsinline>
                <!-- Buffer -->
            </video>

            <!-- Capa Oscura (Overlay) para legibilidad del texto -->
            <div class="absolute top-0 left-0 w-full h-full bg-black/40 z-10 pointer-events-none opacity-0"></div>
        </div>

        <!-- Contenido de la página -->
        <!-- Justify Start + Padding Top para ubicar el logo en el tercio superior -->
        <div class="flex-grow flex flex-col items-center justify-start pt-[30vh] md:pt-[20vh] px-6 pb-0 sm:p-8">

            <!-- Encabezado con el Título -->
            <header class="text-center mb-8 sm:mb-10 w-full flex justify-center">
                <h1 class="w-full max-w-[85vw] sm:max-w-lg md:max-w-2xl">
                    <img src="assets/imagenes/Icono-inicio.png" alt="Lumenfall Logo" class="w-full h-auto object-contain">
                </h1>
            </header>

            <!-- Contenedor de Autenticación -->
            <section class="w-full max-w-sm mx-auto my-6 text-center z-20">
                
                <!-- Spinner de Carga (Visible inicialmente) -->
                <div id="auth-loading-spinner" class="auth-spinner mb-4"></div>

                <div id="auth-container" class="w-full">
                    
                    <div id="login-buttons" class="space-y-4">

                        <button id="install-pwa-button" class="w-full flex items-center justify-center p-3 rounded-lg font-semibold transition-colors duration-200 bg-teal-500 text-white hover:bg-teal-600 hidden" data-i18n="install_app">
                        <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        Instalar Aplicación
                    </button>

                    <button id="google-login" class="w-full flex items-center justify-center p-3 rounded-lg font-semibold transition-colors duration-200 bg-white text-gray-800 hover:bg-gray-200" data-i18n="google_login">
                        <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M43.6111 20.0833H42V20H24V28H35.303C33.6747 32.6596 29.2235 36 24 36C17.373 36 12 30.627 12 24C12 17.373 17.373 12 24 12C26.8543 12 29.4312 13.1118 31.3914 14.888L36.0121 10.2672C32.6393 7.2898 28.5363 5.5 24 5.5C13.797 5.5 5.5 13.797 5.5 24C5.5 34.203 13.797 42.5 24 42.5C34.203 42.5 42.5 34.203 42.5 24C42.5 22.6105 42.3699 21.3533 42.126 20.1388L43.6111 20.0833Z" fill="#FFC107"></path><path d="M43.6111 20.0833H42V20H24V28H35.303C34.5102 30.4187 33.1594 32.5539 31.3914 34.1118L36.0121 38.7328C39.4239 35.034 42.5 29.16 42.5 24C42.5 22.6105 42.3699 21.3533 42.126 20.1388L43.6111 20.0833Z" fill="#FF3D00"></path><path d="M24 5.5C28.5363 5.5 32.6393 7.2898 36.0121 10.2672L31.3914 14.888C29.4312 13.1118 26.8543 12 24 12C20.6974 12 17.817 13.4357 16.0352 15.6961L11.0264 11.8346C14.3315 8.1636 18.892 5.5 24 5.5Z" fill="#4CAF50"></path><path d="M43.6111 20.0833L42.126 20.1388C42.3699 21.3533 42.5 22.6105 42.5 24C42.5 29.16 39.4239 35.034 36.0121 38.7328L31.3914 34.1118C33.1594 32.5539 34.5102 30.4187 35.303 28H24V20H42V20.0833H43.6111Z" fill="#1976D2"></path></svg>
                        Iniciar con Google
                    </button>

                    <button id="open-email-modal" class="w-full flex items-center justify-center p-3 rounded-lg font-semibold transition-colors duration-200 bg-gray-700 text-white hover:bg-gray-600" data-i18n="email_login">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            Iniciar con Correo
                        </button>
                    </div>
                </div>
                
            </section>

            <!-- Navegación Principal -->
            <nav class="w-full max-w-4xl mx-auto mt-8 mb-0 sm:my-10 z-20 px-4 sm:px-0 mt-auto">
                <div class="flex flex-col sm:grid sm:grid-cols-2 sm:gap-6 space-y-6 sm:space-y-0">
                    
                    <a href="./Lumenfall-juego/index.html" class="group block p-4 text-center transition-all duration-300 transform hover:-translate-y-1 neon-active">
                        <span class="block text-2xl sm:text-4xl font-display uppercase text-white neon-hover transition-all duration-300 tracking-wider">JUGAR EL DEMO</span>
                        <span class="block text-sm text-gray-400 group-hover:text-cyan-200 transition-colors duration-300">(La Experiencia Interactiva)</span>
                    </a>
                    
                    <a href="./Lumenfall-libro/index.html" class="group block p-4 text-center transition-all duration-300 transform hover:-translate-y-1 neon-active">
                        <span class="block text-2xl sm:text-4xl font-display uppercase text-white neon-hover transition-all duration-300 tracking-wider">LEER EL LORE</span>
                        <span class="block text-sm text-gray-400 group-hover:text-cyan-200 transition-colors duration-300">(El Grimorio / El Diario)</span>
                    </a>
                    
                    <a href="./Armeria/index.html" class="group block p-4 text-center transition-all duration-300 transform hover:-translate-y-1 neon-active">
                        <span class="block text-2xl sm:text-4xl font-display uppercase text-white neon-hover transition-all duration-300 tracking-wider">LA ARMERÍA</span>
                        <span class="block text-sm text-gray-400 group-hover:text-cyan-200 transition-colors duration-300">(Camisetas y Accesorios)</span>
                    </a>
                    
                    <a href="./Musica/index.html" class="group block p-4 text-center transition-all duration-300 transform hover:-translate-y-1 neon-active">
                        <span class="block text-2xl sm:text-4xl font-display uppercase text-white neon-hover transition-all duration-300 tracking-wider">LA BANDA SONORA</span>
                        <span class="block text-sm text-gray-400 group-hover:text-cyan-200 transition-colors duration-300">(Escuchar 'MY TEMPO')</span>
                    </a>

                </div>
            </nav>

        </div>

        <!-- Footer -->
        <footer class="w-full text-center p-6 mt-auto z-20">
            <!-- Iconos de redes sociales -->
            <div class="flex justify-center space-x-8 mb-4">
                
                <!-- Instagram -->
                <a href="https://www.instagram.com/joziel382025" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
                    <img src="assets/imagenes/icono-redes-sociales/instagram.png?v=1" alt="Instagram" class="w-12 h-12 transition-opacity duration-200 hover:opacity-75">
                </a>
                
                <!-- Facebook -->
                <a href="https://www.facebook.com/share/17hdXVWj2B/" target="_blank" rel="noopener noreferrer" aria-label="Facebook">
                    <img src="assets/imagenes/icono-redes-sociales/facebook.png?v=1" alt="Facebook" class="w-12 h-12 transition-opacity duration-200 hover:opacity-75">
                </a>

                <!-- X (Twitter) -->
                <a href="https://x.com/Joziel380" target="_blank" rel="noopener noreferrer" aria-label="X (Twitter)">
                    <img src="assets/imagenes/icono-redes-sociales/x.png?v=1" alt="X (Twitter)" class="w-12 h-12 transition-opacity duration-200 hover:opacity-75">
                </a>

                <!-- TikTok -->
                <a href="https://www.tiktok.com/@joziel_official" target="_blank" rel="noopener noreferrer" aria-label="TikTok">
                    <img src="assets/imagenes/icono-redes-sociales/tik-tok.png?v=1" alt="TikTok" class="w-12 h-12 transition-opacity duration-200 hover:opacity-75">
                </a>
                
                <!-- YouTube -->
                <a href="https://www.youtube.com/@Joziel38000" target="_blank" rel="noopener noreferrer" aria-label="YouTube">
                    <img src="assets/imagenes/icono-redes-sociales/you-tube.png?v=1" alt="YouTube" class="w-12 h-12 transition-opacity duration-200 hover:opacity-75">
                </a>
            </div>
            <p class="text-gray-500 text-sm mb-2">
                <a href="mailto:joziel.official@gmail.com" class="hover:text-gray-300 transition-colors duration-200">
                    joziel.official@gmail.com
                </a>
            </p>
            <p class="text-gray-500 text-sm">&copy; 2025 JUSN38</p>
        </footer>

    </div>
    
    <!-- Lógica del Splash Screen y PWA -->
    <script>
        window.addEventListener('load', () => {
            const splash = document.getElementById('splash-screen');
            const main = document.getElementById('main-content');
            
            // Lógica de Splash Screen
            function hideSplash(duration) {
                try {
                    sessionStorage.setItem('splashSeen', 'true');
                } catch (e) {
                    console.warn('sessionStorage no está disponible.');
                }

                setTimeout(() => {
                    if (splash) {
                        splash.classList.add('fade-out');
                    }
                    if (main) {
                        main.style.opacity = '1';
                    }
                    
                    setTimeout(() => {
                        if (splash) {
                            splash.style.display = 'none';
                        }
                    }, 500);
                }, duration);
            }

            let splashDuration = 4000;
            try {
                if (sessionStorage.getItem('splashSeen') === 'true') {
                    splashDuration = 0; 
                }
            } catch (e) {
                console.warn('sessionStorage no está disponible.');
            }
            
            hideSplash(splashDuration);

            // Lógica de PWA (Service Worker)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('Service Worker registrado con éxito:', registration);
                    })
                    .catch((error) => {
                        console.error('Error al registrar el Service Worker:', error);
                    });
            }
        });
    </script>

    <!-- LÓGICA DE VIDEO PLAYLIST CON CROSS-FADE -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const playlist = [
                'assets/videos/video-libro.mp4',
                'assets/videos/video-juego.mp4',
                'assets/videos/video-musica.mp4',
                'assets/videos/video-ropa.mp4'
            ];

            let currentIndex = 0;
            const video1 = document.getElementById('bg-video-1');
            const video2 = document.getElementById('bg-video-2');
            let activeVideo = video1; // Empieza con el 1
            let nextVideo = video2;

            // Iniciar el primer video
            video1.src = playlist[0];

            // Al terminar un video, reproducir el siguiente con transición
            function setupNextVideo(endedVideoElement) {
                // Determinar el índice del siguiente
                currentIndex = (currentIndex + 1) % playlist.length;
                const nextSource = playlist[currentIndex];

                // El video que no se está viendo actualmente será el "nextVideo"
                // Si el que terminó es video1, el siguiente (que vamos a mostrar) será video2
                if (endedVideoElement === video1) {
                    activeVideo = video2;
                    nextVideo = video1;
                } else {
                    activeVideo = video1;
                    nextVideo = video2;
                }

                // Preparar el nuevo video activo
                activeVideo.src = nextSource;
                activeVideo.load();

                // Cuando esté listo para reproducirse
                activeVideo.oncanplay = () => {
                    activeVideo.play()
                        .then(() => {
                            // TRANSICIÓN: Hacer visible el nuevo, invisible el viejo
                            activeVideo.classList.remove('opacity-0');
                            activeVideo.classList.add('opacity-100');

                            nextVideo.classList.remove('opacity-100');
                            nextVideo.classList.add('opacity-0');

                            // Importante: Eliminar listener del anterior para evitar duplicados
                            nextVideo.onended = null;
                            activeVideo.onended = () => setupNextVideo(activeVideo);
                        })
                        .catch(err => console.error("Error reproduciendo video:", err));
                };
            }

            // Iniciar la cadena
            video1.onended = () => setupNextVideo(video1);

            // Manejo de errores de autoplay
            video1.play().catch(e => console.log("Autoplay prevenido por el navegador", e));
        });
    </script>

    <!-- Cargar el Sistema de Autenticación Central (El Breaker) -->
    <script type="module" src="assets/js/auth-core.js"></script>

    <!-- Lógica de Traducción (i18n) -->
    <script>
        const translations = {
            es: {
                install_app: "Instalar Aplicación",
                google_login: "Iniciar con Google",
                email_login: "Iniciar con Correo",
                modal_title: "Acceso de Operador",
                email_label: "Correo Electrónico",
                password_label: "Contraseña",
                login_btn: "Iniciar Sesión",
                register_btn: "Registrarse",
                operator_label: "Operador",
                access_code_label: "CÓDIGO DE ACCESO",
                logout_btn: "Cerrar Sesión",
                welcome_alert: "Bienvenido, Operador.",
                auth_error: "Error de autenticación",
                credential_error: "Credenciales incorrectas",
                email_exists_error: "El correo ya está registrado",
                weak_pass_error: "La contraseña es muy débil"
            },
            en: {
                install_app: "Install App",
                google_login: "Sign in with Google",
                email_login: "Sign in with Email",
                modal_title: "Operator Access",
                email_label: "Email Address",
                password_label: "Password",
                login_btn: "Log In",
                register_btn: "Sign Up",
                operator_label: "Operator",
                access_code_label: "ACCESS CODE",
                logout_btn: "Sign Out",
                welcome_alert: "Welcome, Operator.",
                auth_error: "Authentication Error",
                credential_error: "Invalid Credentials",
                email_exists_error: "Email already registered",
                weak_pass_error: "Password is too weak"
            }
        };

        let currentLang = 'es';

        function changeLanguage(lang) {
            currentLang = lang;
            const elements = document.querySelectorAll('[data-i18n]');

            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            // Actualizar opacidad de botones
            document.getElementById('lang-btn-es').style.opacity = lang === 'es' ? '1' : '0.5';
            document.getElementById('lang-btn-en').style.opacity = lang === 'en' ? '1' : '0.5';
        }

        document.getElementById('lang-btn-es').addEventListener('click', () => changeLanguage('es'));
        document.getElementById('lang-btn-en').addEventListener('click', () => changeLanguage('en'));
    </script>

    <!-- Lógica de UI para Autenticación -->
    <script>
        // Referencias al DOM
        const authLoadingSpinner = document.getElementById('auth-loading-spinner');
        const loginButtons = document.getElementById('login-buttons');
        const googleLoginBtn = document.getElementById('google-login');
        const installButton = document.getElementById('install-pwa-button');

        // Modal elements
        const authModal = document.getElementById('auth-modal');
        const openEmailModalBtn = document.getElementById('open-email-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalGoogleBtn = document.getElementById('modal-google-btn');
        const modalGithubBtn = document.getElementById('modal-github-btn');
        const modalMagicLinkBtn = document.getElementById('modal-magic-link-btn');
        const modalEmail = document.getElementById('modal-email');
        const authErrorMsg = document.getElementById('auth-error-msg');
        const authSuccessMsg = document.getElementById('auth-success-msg');

        // Top Right User UI Elements
        const userAvatarContainer = document.getElementById('user-avatar-container');
        const userAvatarBtn = document.getElementById('user-avatar-btn');
        const userAvatarImg = document.getElementById('user-avatar-img');
        const userDropdown = document.getElementById('user-dropdown');
        const menuUserEmail = document.getElementById('menu-user-email');
        const menuGameCode = document.getElementById('menu-game-code');
        const menuLogoutBtn = document.getElementById('menu-logout-btn');
        // Auth Container for centering
        const authContainer = document.getElementById('auth-container');

        // Game Link Gatekeeping
        const gameLink = document.querySelector('a[href="./Lumenfall-juego/index.html"]');

        function initUI() {
            if (!window.LumenfallAuth) {
                requestAnimationFrame(initUI);
                return;
            }

            // --- 0. Chequeo Inicial: Magic Link Return ---
            window.LumenfallAuth.checkAndSignInWithMagicLink().then((result) => {
                if(result.success) {
                    console.log("Magic Link Login Success!", result.user);
                } else if(result.error) {
                    console.error("Magic Link Error", result.error);
                    alert("El enlace ha expirado o es inválido.");
                }
            });

            // --- 1. Botones Principales (Centro) ---
            if(googleLoginBtn) googleLoginBtn.onclick = window.LumenfallAuth.loginWithGoogle;

            // --- 2. Top Right UI Logic ---
            if(userAvatarBtn) {
                userAvatarBtn.onclick = (e) => {
                    e.stopPropagation();
                    userDropdown.classList.toggle('hidden');
                };
            }

            window.addEventListener('click', () => {
                if(userDropdown && !userDropdown.classList.contains('hidden')) {
                    userDropdown.classList.add('hidden');
                }
            });

            if(userDropdown) userDropdown.addEventListener('click', (e) => e.stopPropagation());
            if(menuLogoutBtn) menuLogoutBtn.onclick = window.LumenfallAuth.logout;

            // --- 3. Modal Logic ---
            const showModal = () => {
                authModal.classList.remove('hidden');
                authErrorMsg.classList.add('hidden');
                authSuccessMsg.classList.add('hidden');
            };

            if(openEmailModalBtn) openEmailModalBtn.onclick = showModal;

            // Gatekeeping for Game Link
            if(gameLink) {
                gameLink.onclick = (e) => {
                    if(!window.LumenfallAuth.currentUser) {
                        e.preventDefault(); // Stop navigation
                        showModal(); // Open login
                    }
                };
            }

            if(closeModalBtn) {
                closeModalBtn.onclick = () => {
                    authModal.classList.add('hidden');
                };
            }

            if(authModal) {
                authModal.addEventListener('click', (e) => {
                    if(e.target === authModal) {
                        authModal.classList.add('hidden');
                    }
                });
            }

            // Modal Buttons
            if(modalGoogleBtn) modalGoogleBtn.onclick = window.LumenfallAuth.loginWithGoogle;
            if(modalGithubBtn) modalGithubBtn.onclick = window.LumenfallAuth.loginWithGithub;

            // Magic Link Logic
            if(modalMagicLinkBtn) {
                modalMagicLinkBtn.onclick = async () => {
                    const email = modalEmail.value;
                    if(!email || !email.includes('@')) {
                        authErrorMsg.textContent = "Ingresa un correo válido.";
                        authErrorMsg.classList.remove('hidden');
                        return;
                    }

                    authErrorMsg.classList.add('hidden');

                    const result = await window.LumenfallAuth.sendMagicLink(email);

                    if(result.success) {
                         authSuccessMsg.classList.remove('hidden');
                         modalMagicLinkBtn.textContent = "Reenviar Enlace";
                    } else {
                        authErrorMsg.textContent = "Error al enviar: " + result.error.message;
                        authErrorMsg.classList.remove('hidden');
                    }
                };
            }

            // --- 4. Suscribirse a cambios de estado ---
            window.LumenfallAuth.onStateChanged((user, userData) => {
                // Ocultar Spinner una vez que Firebase responde
                if(authLoadingSpinner) authLoadingSpinner.style.display = 'none';

                if (user) {
                    // --- USUARIO LOGUEADO ---
                    authContainer.style.display = 'none'; // Asegurar oculto
                    userAvatarContainer.classList.remove('hidden'); // Mostrar UI Top

                    // Update Dropdown Data
                    menuUserEmail.textContent = user.email || 'Agente';

                    // Lógica del Avatar (Foto vs Místico)
                    userAvatarBtn.innerHTML = '';

                    if(user.photoURL) {
                        const img = document.createElement('img');
                        img.src = user.photoURL;
                        img.alt = "User";
                        img.className = "w-full h-full object-cover bg-gray-800";
                        userAvatarBtn.appendChild(img);
                        userAvatarBtn.className = "w-12 h-12 rounded-full border-2 border-teal-500 overflow-hidden focus:outline-none focus:ring-2 focus:ring-teal-400";
                    } else {
                        const initial = (user.displayName || user.email || '?').charAt(0).toUpperCase();

                        const mysticDiv = document.createElement('div');
                        mysticDiv.className = "mystic-avatar";
                        mysticDiv.textContent = initial;

                        userAvatarBtn.appendChild(mysticDiv);
                        userAvatarBtn.className = "w-12 h-12 rounded-full overflow-hidden focus:outline-none focus:ring-2 focus:ring-teal-400";
                    }

                    if (userData && userData.gameCode) {
                        menuGameCode.textContent = userData.gameCode;
                    } else {
                        menuGameCode.textContent = "----";
                    }
                } else {
                    // --- NO USUARIO (LOGIN) ---
                    authContainer.style.display = 'block'; // Mostrar Login
                    userAvatarContainer.classList.add('hidden'); // Ocultar UI Top
                    loginButtons.classList.remove('hidden');
                }
            });
        }

        // Iniciar
        initUI();

        // Prompt de Instalación PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if(installButton) installButton.classList.remove('hidden');
        });
        if(installButton) {
            installButton.addEventListener('click', async () => {
                installButton.classList.add('hidden');
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                }
            });
        }
        window.addEventListener('appinstalled', () => {
            if(installButton) installButton.classList.add('hidden');
            deferredPrompt = null;
        });
    </script>

</body>
</html>
